import{s as u,p as f}from"./supabaseClient-ohoVkaTe.js";async function y(){const{data:e,error:t}=await u.from("profiles").select("id,email,username");if(t){console.error("Błąd ładowania profili:",t);return}f.clear(),e.forEach(({id:n,email:a,username:b})=>{f.set(n,{email:a,username:b})})}function L(e){const t=f.get(e);return t&&(t.username||t.email)||e}let m=null,g=null,h=null,p,r,s,c,l,d,i,o=null;async function w(){p=document.getElementById("contactsList"),r=document.getElementById("messageContainer"),s=document.getElementById("messageInput"),c=document.getElementById("sendButton"),l=document.getElementById("logoScreen"),d=document.getElementById("chatArea"),i=document.getElementById("backButton");const{data:{session:e}}=await u.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}m=e.user,await y(),S(),k(),B(),setInterval(y,10*60*1e3),l.classList.remove("hidden"),d.classList.remove("active"),i.classList.remove("show"),s.disabled=!0,c.disabled=!0,i.addEventListener("click",()=>{d.classList.remove("active"),l.classList.remove("hidden"),i.classList.remove("show"),r.innerHTML="",s.disabled=!0,c.disabled=!0})}async function S(){const{data:e,error:t}=await u.rpc("get_other_users",{current_email:m.email});if(t)return alert("Błąd ładowania kontaktów");p.innerHTML="",e.forEach(n=>{const a=document.createElement("li");a.classList.add("contact"),a.dataset.id=n.id,a.textContent=L(n.id),a.onclick=()=>E(n),p.appendChild(a)})}function v(e,t){return[e,t].sort().join("_")}async function E(e){l.classList.add("hidden"),d.classList.add("active"),i.classList.add("show"),g={id:e.id,username:L(e.id)},r.innerHTML="",h=v(m.email,e.email),o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"join",name:m.email,room:h})),document.getElementById("chatUserName").textContent=g.username,s.disabled=!1,c.disabled=!1,s.focus()}function k(){c.onclick=()=>{const e=s.value.trim();if(!e||!g||!o||o.readyState!==WebSocket.OPEN)return;const t={type:"message",text:e,room:h};o.send(JSON.stringify(t)),s.value="",s.focus()}}function B(){const e="wss://firm-chat-app-backend.onrender.com";o=new WebSocket(e),o.onopen=()=>{console.log("WebSocket połączony")},o.onmessage=t=>{const n=JSON.parse(t.data);if(console.log("Odebrano przez WS:",n),n.type==="message"&&addMessageToChat({sender:n.sender,text:n.text}),n.type==="history"&&Array.isArray(n.messages)&&n.messages.forEach(a=>addMessageToChat(a)),n.type==="info"){const a=document.createElement("div");a.classList.add("info"),a.textContent=n.text,r.appendChild(a),r.scrollTop=r.scrollHeight}},o.onclose=()=>{console.log("WebSocket rozłączony")},o.onerror=t=>{console.error("Błąd WebSocket:",t)}}document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await u.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await w()});
