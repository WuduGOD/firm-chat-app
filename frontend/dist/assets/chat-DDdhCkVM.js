import{s as f,p as g}from"./supabaseClient-B_jAcGQG.js";async function L(){const{data:e,error:n}=await f.from("profiles").select("id,email,username");if(n){console.error("Błąd ładowania profili:",n);return}g.clear(),e.forEach(({id:t,email:s,username:w})=>{g.set(t,{email:s,username:w})})}function y(e){const n=g.get(e);return n&&(n.username||n.email)||e}let i=null,d=null,p=null,h,r,o,l,u,m,c,a=null;async function S(){h=document.getElementById("contactsList"),r=document.getElementById("messageContainer"),o=document.getElementById("messageInput"),l=document.getElementById("sendButton"),u=document.getElementById("logoScreen"),m=document.getElementById("chatArea"),c=document.getElementById("backButton");const{data:{session:e}}=await f.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}i=e.user,await L(),await v(),B(),I(),setInterval(L,10*60*1e3),u.classList.remove("hidden"),m.classList.remove("active"),c.classList.remove("show"),o.disabled=!0,l.disabled=!0,c.addEventListener("click",()=>{m.classList.remove("active"),u.classList.remove("hidden"),c.classList.remove("show"),r.innerHTML="",o.disabled=!0,l.disabled=!0})}async function v(){const{data:e,error:n}=await f.rpc("get_other_users",{current_email:i.email});if(n){alert("Błąd ładowania kontaktów");return}h.innerHTML="",e.forEach(t=>{const s=document.createElement("li");s.classList.add("contact"),s.dataset.id=t.id,s.textContent=y(t.id),s.onclick=()=>k(t),h.appendChild(s)})}function E(e,n){return[e,n].sort().join("_")}async function k(e){u.classList.add("hidden"),m.classList.add("active"),c.classList.add("show"),d={id:e.id,username:y(e.id),email:e.email},r.innerHTML="",p=E(i.email,d.email),a&&a.readyState===WebSocket.OPEN&&a.send(JSON.stringify({type:"join",name:i.email,room:p})),document.getElementById("chatUserName").textContent=d.username,o.disabled=!1,l.disabled=!1,o.focus()}function B(){l.onclick=()=>{const e=o.value.trim();if(!e||!d||!a||a.readyState!==WebSocket.OPEN)return;const n={type:"message",text:e,room:p};a.send(JSON.stringify(n)),o.value="",o.focus()}}function b(e){const n=e.sender===i.email?"Ty":y(e.sender)||e.sender,t=document.createElement("div");t.classList.add("message",e.sender===i.email?"sent":"received"),t.textContent=`${n}: ${e.text}`,r.appendChild(t),r.scrollTop=r.scrollHeight}function C(e,n){const t=document.querySelector(`.contact[data-id="${e}"]`);t&&t.classList.toggle("online",n)}function I(){const e="wss://firm-chat-app-backend.onrender.com";a=new WebSocket(e),a.onopen=()=>{console.log("WebSocket połączony")},a.onmessage=n=>{const t=JSON.parse(n.data);console.log("Odebrano przez WS:",t),t.type==="message"&&b({sender:t.username||t.sender,text:t.text}),t.type==="history"&&Array.isArray(t.messages)&&t.messages.forEach(s=>b(s)),t.type==="status"&&C(t.user,t.online)},a.onclose=()=>{console.log("WebSocket rozłączony")},a.onerror=n=>{console.error("Błąd WebSocket:",n)}}document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await f.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await S()});
