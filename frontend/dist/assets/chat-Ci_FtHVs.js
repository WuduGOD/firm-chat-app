import{c as h}from"./index-9sBxIpUg.js";const l=new Map,w="https://tatiuvcmkzgcclwnehyr.supabase.co",I="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",r=h(w,I);async function f(){const{data:e,error:s}=await r.from("profiles").select("id,email,username");if(s){console.error("Błąd ładowania profili:",s);return}l.clear(),e.forEach(({id:t,email:i,username:c})=>{l.set(t,{email:i,username:c})})}function u(e){const s=l.get(e);return s&&(s.username||s.email)||e}let n=null,a=null;async function v(){document.getElementById("contactsList"),document.getElementById("messageContainer"),document.getElementById("messageInput"),document.getElementById("sendButton");const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}n=e.user,await f(),y(),C(),M(n),setInterval(f,10*60*1e3)}async function y(){const{data:e,error:s}=await r.rpc("get_other_users",{current_email:n.email});if(s)return alert("Błąd ładowania kontaktów");contactsList.innerHTML="",e.forEach(t=>{const i=document.createElement("li");i.dataset.id=t.id,i.textContent=u(t.id),i.onclick=()=>b(t),contactsList.appendChild(i)})}async function b(e){a={id:e.id,username:u(e.id)},messagesDiv.innerHTML="";const{data:s,error:t}=await r.from("messages").select("*").eq("sender",n.id).eq("receiver",e.id),{data:i,error:c}=await r.from("messages").select("*").eq("sender",e.id).eq("receiver",n.id);if(t||c)return console.error("Błąd ładowania wiadomości:",t||c),alert("Błąd ładowania wiadomości");const g=[...s,...i].sort((d,p)=>new Date(d.created_at)-new Date(p.created_at));for(const d of g)await m(d);messagesDiv.scrollTop=messagesDiv.scrollHeight}function C(){sendBtn.onclick=async()=>{const e=inputMsg.value.trim();if(!e||!a)return;const{error:s}=await r.from("messages").insert({sender:n.id,receiver:a.id,text:e});if(s)return alert("Błąd wysyłania");inputMsg.value=""}}async function m(e){const s=e.sender===n.id?"Ty":u(e.sender),t=document.createElement("div");t.textContent=`${s}: ${e.text}`,messagesDiv.appendChild(t),messagesDiv.scrollTop=messagesDiv.scrollHeight}let o=null;function M(e){o&&o.unsubscribe(),o=r.channel(`messages_channel_${e.id}`),o.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver=eq.${e.id}`},async s=>{const t=s.new;a&&(t.sender===a.id&&t.receiver===n.id||t.sender===n.id&&t.receiver===a.id)&&await m(t)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`sender=eq.${e.id}`},async s=>{const t=s.new;a&&(t.sender===n.id&&t.receiver===a.id||t.sender===a.id&&t.receiver===n.id)&&await m(t)}).subscribe()}(async()=>{const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/";return}v()})();
