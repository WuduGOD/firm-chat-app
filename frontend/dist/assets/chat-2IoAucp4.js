import{s as b,p}from"./supabaseClient-ohoVkaTe.js";async function L(){const{data:e,error:t}=await b.from("profiles").select("id,email,username");if(t){console.error("Błąd ładowania profili:",t);return}p.clear(),e.forEach(({id:n,email:a,username:i})=>{p.set(n,{email:a,username:i})})}function w(e){const t=p.get(e);return t&&(t.username||t.email)||e}let c=null,m=null,g=null,h,o,r,d,u,f,l,s=null;async function v(){h=document.getElementById("contactsList"),o=document.getElementById("messageContainer"),r=document.getElementById("messageInput"),d=document.getElementById("sendButton"),u=document.getElementById("logoScreen"),f=document.getElementById("chatArea"),l=document.getElementById("backButton");const{data:{session:e}}=await b.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}c=e.user,await L(),E(),B(),C(),setInterval(L,10*60*1e3),u.classList.remove("hidden"),f.classList.remove("active"),l.classList.remove("show"),r.disabled=!0,d.disabled=!0,l.addEventListener("click",()=>{f.classList.remove("active"),u.classList.remove("hidden"),l.classList.remove("show"),o.innerHTML="",r.disabled=!0,d.disabled=!0})}async function E(){const e=window.supabase,{data:t,error:n}=await e.rpc("get_other_users",{current_email:c.email});if(n)return alert("Błąd ładowania kontaktów");h.innerHTML="",t.forEach(a=>{const i=document.createElement("li");i.classList.add("contact"),i.dataset.id=a.id,i.textContent=w(a.id),i.onclick=()=>k(a),h.appendChild(i)})}function S(e,t){return[e,t].sort().join("_")}async function k(e){u.classList.add("hidden"),f.classList.add("active"),l.classList.add("show"),m={id:e.id,username:w(e.id)},o.innerHTML="",g=S(c.email,m.username),s&&s.readyState===WebSocket.OPEN&&s.send(JSON.stringify({type:"join",name:c.email,room:g})),document.getElementById("chatUserName").textContent=m.username,r.disabled=!1,d.disabled=!1,r.focus()}function B(){d.onclick=()=>{const e=r.value.trim();if(!e||!m||!s||s.readyState!==WebSocket.OPEN)return;const t={type:"message",text:e,room:g};s.send(JSON.stringify(t)),r.value="",r.focus(),y({sender:c.email,text:e})}}function y(e){const t=e.sender===c.email?"Ty":w(e.sender)||e.sender,n=document.createElement("div");n.classList.add("message",e.sender===c.email?"sent":"received"),n.textContent=`${t}: ${e.text}`,o.appendChild(n),o.scrollTop=o.scrollHeight}function C(){const e="wss://firm-chat-app-backend.onrender.com";s=new WebSocket(e),s.onopen=()=>{console.log("WebSocket połączony")},s.onmessage=t=>{const n=JSON.parse(t.data);if(console.log("Odebrano przez WS:",n),n.type==="message"&&y({sender:n.username,text:n.text}),n.type==="history"&&Array.isArray(n.messages)&&n.messages.forEach(a=>y(a)),n.type==="info"){const a=document.createElement("div");a.classList.add("info"),a.textContent=n.text,o.appendChild(a),o.scrollTop=o.scrollHeight}},s.onclose=()=>{console.log("WebSocket rozłączony")},s.onerror=t=>{console.error("Błąd WebSocket:",t)}}document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await b.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await v()});
