import{p,s as g}from"./supabaseClient-B_jAcGQG.js";async function L(){const{data:e,error:t}=await g.from("profiles").select("id,email,username");if(t){console.error("Błąd ładowania profili:",t);return}p.clear(),e.forEach(({id:a,email:o,username:w})=>{p.set(a,{email:o,username:w})})}function h(e){const t=p.get(e);return t&&(t.username||t.email)||e}let i=null,m=null,d=null,y,r,s,c,u,f,l,n=null,S=0;async function E(){y=document.getElementById("contactsList"),r=document.getElementById("messageContainer"),s=document.getElementById("messageInput"),c=document.getElementById("sendButton"),u=document.getElementById("logoScreen"),f=document.getElementById("chatArea"),l=document.getElementById("backButton");const{data:{session:e}}=await g.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}i=e.user,await L(),await v(),I(),k(),setInterval(L,10*60*1e3),u.classList.remove("hidden"),f.classList.remove("active"),l.classList.remove("show"),s.disabled=!0,c.disabled=!0,l.addEventListener("click",()=>{f.classList.remove("active"),u.classList.remove("hidden"),l.classList.remove("show"),r.innerHTML="",s.disabled=!0,c.disabled=!0})}async function v(){const{data:e,error:t}=await g.rpc("get_other_users",{current_email:i.email});if(t){alert("Błąd ładowania kontaktów");return}y.innerHTML="",e.forEach(a=>{const o=document.createElement("li");o.classList.add("contact"),o.dataset.id=a.id,o.textContent=h(a.id),o.onclick=()=>C(a),y.appendChild(o)})}function B(e,t){return[e,t].sort().join("_")}async function C(e){u.classList.add("hidden"),f.classList.add("active"),l.classList.add("show"),m={id:e.id,username:h(e.id)||e.email,email:e.email},r.innerHTML="",d=B(i.email,m.email),n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"join",name:i.email,room:d})),document.getElementById("chatUserName").textContent=m.username,s.disabled=!1,c.disabled=!1,s.focus()}function I(){c.onclick=()=>{const e=s.value.trim();if(!e||!m||!n||n.readyState!==WebSocket.OPEN)return;const t={type:"message",username:i.email,text:e,room:d};console.log("Wysyłanie wiadomości:",t),n.send(JSON.stringify(t)),s.value="",s.focus()},s.addEventListener("keydown",e=>{e.key==="Enter"&&c.click()})}function b(e){console.log("Dodawanie wiadomości do interfejsu:",e);const t=e.username===i.email?"Ty":h(e.username)||e.username,a=document.createElement("div");a.classList.add("message",e.username===i.email?"sent":"received");let o="";e.inserted_at&&(o=` <span class="time">${new Date(e.inserted_at).toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"})}</span>`),a.innerHTML=`<strong>${t}</strong>: ${e.text}${o}`,r.appendChild(a),r.scrollTop=r.scrollHeight}function O(e,t){const a=document.querySelector(`.contact[data-id="${e}"]`);a&&a.classList.toggle("online",t)}function k(){const e="wss://firm-chat-app-backend.onrender.com";n=new WebSocket(e),n.onopen=()=>{console.log("WebSocket połączony"),S=0,d&&i&&n.send(JSON.stringify({type:"join",name:i.email,room:d}))},n.onmessage=t=>{const a=JSON.parse(t.data);console.log("Odebrana wiadomość przez WebSocket:",a),a.type==="message"&&(console.log("Dodawanie wiadomości do interfejsu:",a),b({username:a.username,text:a.text,inserted_at:a.inserted_at}))},data.type==="history"&&Array.isArray(data.messages)&&(console.log("Ładowanie historii wiadomości:",data.messages),data.messages.forEach(t=>b(t))),data.type==="status"&&O(data.user,data.online)}n.onclose=()=>{console.log("WebSocket rozłączony. Próba ponownego połączenia..."),setTimeout(k,Math.min(1e3*++S,1e4))};n.onerror=e=>{console.error("Błąd WebSocket:",e)};document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await g.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await E()});
