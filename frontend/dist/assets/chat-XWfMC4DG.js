import{c as g}from"./index-9sBxIpUg.js";const u=new Map,b="https://tatiuvcmkzgcclwnehyr.supabase.co",C="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",r=g(b,C);async function I(){const{data:e,error:n}=await r.from("profiles").select("id,email,username");if(n){console.error("Błąd ładowania profili:",n);return}u.clear(),e.forEach(({id:t,email:i,username:o})=>{u.set(t,{email:i,username:o})})}function p(e){const n=u.get(e);return n&&(n.username||n.email)||e}let s=null,a=null;const f=document.getElementById("contactsList"),c=document.getElementById("messageContainer"),h=document.getElementById("messageInput"),M=document.getElementById("sendButton");async function v(){const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}s=e.user,await I(),E(),B(),O(s),setInterval(I,10*60*1e3)}async function E(){const{data:e,error:n}=await r.rpc("get_other_users",{current_email:s.email});if(n)return alert("Błąd ładowania kontaktów");f.innerHTML="",e.forEach(t=>{const i=document.createElement("li");i.dataset.id=t.id,i.textContent=p(t.id),i.onclick=()=>J(t),f.appendChild(i)})}async function J(e){a={id:e.id,username:p(e.id)},c.innerHTML="";const{data:n,error:t}=await r.from("messages").select("*").eq("sender",s.id).eq("receiver",e.id),{data:i,error:o}=await r.from("messages").select("*").eq("sender",e.id).eq("receiver",s.id);if(t||o)return console.error("Błąd ładowania wiadomości:",t||o),alert("Błąd ładowania wiadomości");const w=[...n,...i].sort((l,y)=>new Date(l.created_at)-new Date(y.created_at));for(const l of w)await m(l);c.scrollTop=c.scrollHeight}function B(){M.onclick=async()=>{const e=h.value.trim();if(!e||!a)return;const{error:n}=await r.from("messages").insert({sender:s.id,receiver:a.id,text:e});if(n)return alert("Błąd wysyłania");h.value=""}}async function m(e){const n=e.sender===s.id?"Ty":p(e.sender),t=document.createElement("div");t.textContent=`${n}: ${e.text}`,c.appendChild(t),c.scrollTop=c.scrollHeight}let d=null;function O(e){d&&d.unsubscribe(),d=r.channel(`messages_channel_${e.id}`),d.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver=eq.${e.id}`},async n=>{const t=n.new;a&&(t.sender===a.id&&t.receiver===s.id||t.sender===s.id&&t.receiver===a.id)&&await m(t)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`sender=eq.${e.id}`},async n=>{const t=n.new;a&&(t.sender===s.id&&t.receiver===a.id||t.sender===a.id&&t.receiver===s.id)&&await m(t)}).subscribe()}const Z="https://tatiuvcmkzgcclwnehyr.supabase.co",D="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",S=g(Z,D);(async()=>{const{data:{session:e}}=await S.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/";return}v()})();
