import{c as L}from"./index-CXsQKt-S.js";const f=new Map,v="https://tatiuvcmkzgcclwnehyr.supabase.co",E="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",w=L(v,E);async function I(){const{data:e,error:t}=await w.from("profiles").select("id,email,username");if(t){console.error("Błąd ładowania profili:",t);return}f.clear(),e.forEach(({id:n,email:s,username:c})=>{f.set(n,{email:s,username:c})})}function b(e){const t=f.get(e);return t&&(t.username||t.email)||e}let r=null,m=null,h=null,g,o,i,d,u,p,l,a=null;async function S(){g=document.getElementById("contactsList"),o=document.getElementById("messageContainer"),i=document.getElementById("messageInput"),d=document.getElementById("sendButton"),u=document.getElementById("logoScreen"),p=document.getElementById("chatArea"),l=document.getElementById("backButton");const e=window.supabase,{data:{session:t}}=await e.auth.getSession();if(!(t!=null&&t.user)){window.location.href="login.html";return}r=t.user,await I(),C(),M(),O(),setInterval(I,10*60*1e3),u.classList.remove("hidden"),p.classList.remove("active"),l.classList.remove("show"),i.disabled=!0,d.disabled=!0,l.addEventListener("click",()=>{p.classList.remove("active"),u.classList.remove("hidden"),l.classList.remove("show"),o.innerHTML="",i.disabled=!0,d.disabled=!0})}async function C(){const e=window.supabase,{data:t,error:n}=await e.rpc("get_other_users",{current_email:r.email});if(n)return alert("Błąd ładowania kontaktów");g.innerHTML="",t.forEach(s=>{const c=document.createElement("li");c.classList.add("contact"),c.dataset.id=s.id,c.textContent=b(s.id),c.onclick=()=>B(s),g.appendChild(c)})}function k(e,t){return[e,t].sort().join("_")}async function B(e){u.classList.add("hidden"),p.classList.add("active"),l.classList.add("show"),m={id:e.id,username:b(e.id)},o.innerHTML="",h=k(r.email,m.username),a&&a.readyState===WebSocket.OPEN&&a.send(JSON.stringify({type:"join",name:r.email,room:h})),document.getElementById("chatUserName").textContent=m.username,i.disabled=!1,d.disabled=!1,i.focus()}function M(){d.onclick=()=>{const e=i.value.trim();if(!e||!m||!a||a.readyState!==WebSocket.OPEN)return;const t={type:"message",text:e,room:h};a.send(JSON.stringify(t)),i.value="",i.focus(),y({sender:r.email,text:e})}}function y(e){const t=e.sender===r.email?"Ty":b(e.sender)||e.sender,n=document.createElement("div");n.classList.add("message",e.sender===r.email?"sent":"received"),n.textContent=`${t}: ${e.text}`,o.appendChild(n),o.scrollTop=o.scrollHeight}function O(){const e="wss://firm-chat-app-backend.onrender.com";a=new WebSocket(e),a.onopen=()=>{console.log("WebSocket połączony")},a.onmessage=t=>{const n=JSON.parse(t.data);if(console.log("Odebrano przez WS:",n),n.type==="message"&&y({sender:n.username,text:n.text}),n.type==="history"&&Array.isArray(n.messages)&&n.messages.forEach(s=>y(s)),n.type==="info"){const s=document.createElement("div");s.classList.add("info"),s.textContent=n.text,o.appendChild(s),o.scrollTop=o.scrollHeight}},a.onclose=()=>{console.log("WebSocket rozłączony")},a.onerror=t=>{console.error("Błąd WebSocket:",t)}}document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await w.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await S()});
