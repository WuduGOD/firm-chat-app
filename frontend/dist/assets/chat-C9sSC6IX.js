import{c as b}from"./index-9sBxIpUg.js";const m=new Map,v="https://tatiuvcmkzgcclwnehyr.supabase.co",C="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",r=b(v,C);async function w(){const{data:e,error:n}=await r.from("profiles").select("id,email,username");if(n){console.error("Błąd ładowania profili:",n);return}m.clear(),e.forEach(({id:t,email:i,username:d})=>{m.set(t,{email:i,username:d})})}function h(e){const n=m.get(e);return n&&(n.username||n.email)||e}let a=null,s=null,f,c,o,p;async function E(){f=document.getElementById("contactsList"),c=document.getElementById("messageContainer"),o=document.getElementById("messageInput"),p=document.getElementById("sendButton");const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}a=e.user,await w(),M(),T(),L(a),setInterval(w,10*60*1e3)}async function M(){const{data:e,error:n}=await r.rpc("get_other_users",{current_email:a.email});if(n)return alert("Błąd ładowania kontaktów");f.innerHTML="",e.forEach(t=>{const i=document.createElement("li");i.dataset.id=t.id,i.textContent=h(t.id),i.onclick=()=>B(t),f.appendChild(i)})}async function B(e){s={id:e.id,username:h(e.id)},c.innerHTML="";const{data:n,error:t}=await r.from("messages").select("*").eq("sender",a.id).eq("receiver",e.id),{data:i,error:d}=await r.from("messages").select("*").eq("sender",e.id).eq("receiver",a.id);if(t||d)return console.error("Błąd ładowania wiadomości:",t||d),alert("Błąd ładowania wiadomości");const I=[...n,...i].sort((u,y)=>new Date(u.created_at)-new Date(y.created_at));for(const u of I)await g(u);c.scrollTop=c.scrollHeight,document.getElementById("chatUserName").textContent=s.username,o.disabled=!1,p.disabled=!1,o.focus()}function T(){p.onclick=async()=>{const e=o.value.trim();if(!e||!s)return;const{error:n}=await r.from("messages").insert({sender:a.id,receiver:s.id,text:e});if(n)return alert("Błąd wysyłania");o.value="",o.focus()}}async function g(e){const n=e.sender===a.id?"Ty":h(e.sender),t=document.createElement("div");t.textContent=`${n}: ${e.text}`,c.appendChild(t),c.scrollTop=c.scrollHeight}let l=null;function L(e){l&&l.unsubscribe(),l=r.channel(`messages_channel_${e.id}`),l.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver=eq.${e.id}`},async n=>{const t=n.new;s&&(t.sender===s.id&&t.receiver===a.id||t.sender===a.id&&t.receiver===s.id)&&await g(t)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`sender=eq.${e.id}`},async n=>{const t=n.new;s&&(t.sender===a.id&&t.receiver===s.id||t.sender===s.id&&t.receiver===a.id)&&await g(t)}).subscribe()}document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await E()});
