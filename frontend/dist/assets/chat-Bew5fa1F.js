import{s as g,p as y}from"./supabaseClient-B_jAcGQG.js";async function b(){const{data:e,error:n}=await g.from("profiles").select("id,email,username");if(n){console.error("Błąd ładowania profili:",n);return}y.clear(),e.forEach(({id:t,email:a,username:L})=>{y.set(t,{email:a,username:L})})}function w(e){const n=y.get(e);return n&&(n.username||n.email)||e}let i=null,m=null,d=null,h,r,s,c,u,f,l,o=null,S=0;async function k(){h=document.getElementById("contactsList"),r=document.getElementById("messageContainer"),s=document.getElementById("messageInput"),c=document.getElementById("sendButton"),u=document.getElementById("logoScreen"),f=document.getElementById("chatArea"),l=document.getElementById("backButton");const{data:{session:e}}=await g.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}i=e.user,await b(),await v(),I(),E(),setInterval(b,10*60*1e3),u.classList.remove("hidden"),f.classList.remove("active"),l.classList.remove("show"),s.disabled=!0,c.disabled=!0,l.addEventListener("click",()=>{f.classList.remove("active"),u.classList.remove("hidden"),l.classList.remove("show"),r.innerHTML="",s.disabled=!0,c.disabled=!0})}async function v(){const{data:e,error:n}=await g.rpc("get_other_users",{current_email:i.email});if(n){alert("Błąd ładowania kontaktów");return}h.innerHTML="",e.forEach(t=>{const a=document.createElement("li");a.classList.add("contact"),a.dataset.id=t.id,a.textContent=w(t.id),a.onclick=()=>C(t),h.appendChild(a)})}function B(e,n){return[e,n].sort().join("_")}async function C(e){u.classList.add("hidden"),f.classList.add("active"),l.classList.add("show"),m={id:e.id,username:w(e.id)||e.email,email:e.email},r.innerHTML="",d=B(i.email,m.email),o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"join",name:i.email,room:d})),document.getElementById("chatUserName").textContent=m.username,s.disabled=!1,c.disabled=!1,s.focus()}function I(){c.onclick=()=>{const e=s.value.trim();if(!e||!m||!o||o.readyState!==WebSocket.OPEN)return;const n={type:"message",username:i.email,text:e,room:d};console.log("Wysyłanie wiadomości:",n),o.send(JSON.stringify(n)),s.value="",s.focus()},s.addEventListener("keydown",e=>{e.key==="Enter"&&c.click()})}function p(e){console.log("Dodawanie wiadomości do interfejsu:",e);const n=e.username===i.email?"Ty":w(e.username)||e.username,t=document.createElement("div");t.classList.add("message",e.username===i.email?"sent":"received");let a="";e.inserted_at&&(a=` <span class="time">${new Date(e.inserted_at).toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"})}</span>`),t.innerHTML=`<strong>${n}</strong>: ${e.text}${a}`,r.appendChild(t),r.scrollTop=r.scrollHeight}function O(e,n){const t=document.querySelector(`.contact[data-id="${e}"]`);t&&t.classList.toggle("online",n)}function E(){const e="wss://firm-chat-app-backend.onrender.com";o=new WebSocket(e),o.onopen=()=>{console.log("WebSocket połączony"),S=0,d&&i&&o.send(JSON.stringify({type:"join",name:i.email,room:d}))},o.onmessage=n=>{const t=JSON.parse(n.data);console.log("Odebrano przez WS:",t),t.type==="message"?p({username:t.username,text:t.text,inserted_at:t.inserted_at}):t.type==="history"?Array.isArray(t.messages)?(console.log("Ładowanie historii wiadomości (tablica):",t.messages),t.messages.forEach(a=>p(a))):(console.log("Ładowanie historii wiadomości (pojedyncza):",t),p(t)):t.type==="status"&&O(t.user,t.online)},o.onclose=()=>{console.log("WebSocket rozłączony. Próba ponownego połączenia..."),setTimeout(E,Math.min(1e3*++S,1e4))},o.onerror=n=>{console.error("Błąd WebSocket:",n)}}document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await g.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await k()});
