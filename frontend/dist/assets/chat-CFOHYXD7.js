import{c as b}from"./index-9sBxIpUg.js";const u=new Map,v="https://tatiuvcmkzgcclwnehyr.supabase.co",C="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",r=b(v,C);async function h(){const{data:e,error:n}=await r.from("profiles").select("id,email,username");if(n){console.error("Błąd ładowania profili:",n);return}u.clear(),e.forEach(({id:t,email:i,username:o})=>{u.set(t,{email:i,username:o})})}function p(e){const n=u.get(e);return n&&(n.username||n.email)||e}let a=null,s=null,m,c,f,w;async function M(){m=document.getElementById("contactsList"),c=document.getElementById("messageContainer"),f=document.getElementById("messageInput"),w=document.getElementById("sendButton");const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}a=e.user,await h(),B(),T(),_(a),setInterval(h,10*60*1e3)}async function B(){const{data:e,error:n}=await r.rpc("get_other_users",{current_email:a.email});if(n)return alert("Błąd ładowania kontaktów");m.innerHTML="",e.forEach(t=>{const i=document.createElement("li");i.dataset.id=t.id,i.textContent=p(t.id),i.onclick=()=>E(t),m.appendChild(i)})}async function E(e){s={id:e.id,username:p(e.id)},c.innerHTML="";const{data:n,error:t}=await r.from("messages").select("*").eq("sender",a.id).eq("receiver",e.id),{data:i,error:o}=await r.from("messages").select("*").eq("sender",e.id).eq("receiver",a.id);if(t||o)return console.error("Błąd ładowania wiadomości:",t||o),alert("Błąd ładowania wiadomości");const I=[...n,...i].sort((d,y)=>new Date(d.created_at)-new Date(y.created_at));for(const d of I)await g(d);c.scrollTop=c.scrollHeight}function T(){w.onclick=async()=>{const e=f.value.trim();if(!e||!s)return;const{error:n}=await r.from("messages").insert({sender:a.id,receiver:s.id,text:e});if(n)return alert("Błąd wysyłania");f.value=""}}async function g(e){const n=e.sender===a.id?"Ty":p(e.sender),t=document.createElement("div");t.textContent=`${n}: ${e.text}`,c.appendChild(t),c.scrollTop=c.scrollHeight}let l=null;function _(e){l&&l.unsubscribe(),l=r.channel(`messages_channel_${e.id}`),l.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver=eq.${e.id}`},async n=>{const t=n.new;s&&(t.sender===s.id&&t.receiver===a.id||t.sender===a.id&&t.receiver===s.id)&&await g(t)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`sender=eq.${e.id}`},async n=>{const t=n.new;s&&(t.sender===a.id&&t.receiver===s.id||t.sender===s.id&&t.receiver===a.id)&&await g(t)}).subscribe()}(async()=>{const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/";return}M()})();
