import{c as B}from"./index-CLr0GVE1.js";const w=new Map,E="https://tatiuvcmkzgcclwnehyr.supabase.co",C="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",d=B(E,C);async function b(){const{data:e,error:s}=await d.from("profiles").select("id,email,username");if(s){console.error("Błąd ładowania profili:",s);return}w.clear(),e.forEach(({id:t,email:i,username:m})=>{w.set(t,{email:i,username:m})})}function I(e){const s=w.get(e);return s&&(s.username||s.email)||e}let a=null,n=null,p,r,c,l,f,h,o;async function M(){p=document.getElementById("contactsList"),r=document.getElementById("messageContainer"),c=document.getElementById("messageInput"),l=document.getElementById("sendButton"),f=document.getElementById("logoScreen"),h=document.getElementById("chatArea"),o=document.getElementById("backButton");const{data:{session:e}}=await d.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}a=e.user,await b(),T(),k(),_(a),setInterval(b,10*60*1e3),f.classList.remove("hidden"),h.classList.remove("active"),o.classList.remove("show"),c.disabled=!0,l.disabled=!0,o.addEventListener("click",()=>{h.classList.remove("active"),f.classList.remove("hidden"),o.classList.remove("show"),r.innerHTML="",c.disabled=!0,l.disabled=!0})}async function T(){const{data:e,error:s}=await d.rpc("get_other_users",{current_email:a.email});if(s)return alert("Błąd ładowania kontaktów");p.innerHTML="",e.forEach(t=>{const i=document.createElement("li");i.classList.add("contact"),i.dataset.id=t.id,i.textContent=I(t.id),i.onclick=()=>S(t),p.appendChild(i)})}async function S(e){f.classList.add("hidden"),h.classList.add("active"),o.classList.add("show"),n={id:e.id,username:I(e.id)},r.innerHTML="";const{data:s,error:t}=await d.from("messages").select("*").eq("sender",a.id).eq("receiver",e.id),{data:i,error:m}=await d.from("messages").select("*").eq("sender",e.id).eq("receiver",a.id);if(t||m)return console.error("Błąd ładowania wiadomości:",t||m),alert("Błąd ładowania wiadomości");const y=[...s,...i].sort((g,L)=>new Date(g.created_at)-new Date(L.created_at));for(const g of y)await v(g);r.scrollTop=r.scrollHeight,document.getElementById("chatUserName").textContent=n.username,c.disabled=!1,l.disabled=!1,c.focus()}function k(){l.onclick=async()=>{const e=c.value.trim();if(!e||!n)return;const{error:s}=await d.from("messages").insert({sender:a.id,receiver:n.id,text:e});if(s)return alert("Błąd wysyłania");c.value="",c.focus()}}async function v(e){const s=e.sender===a.id?"Ty":I(e.sender),t=document.createElement("div");e.sender===a.id?t.classList.add("message","sent"):t.classList.add("message","received"),t.textContent=`${s}: ${e.text}`,r.appendChild(t),r.scrollTop=r.scrollHeight}let u=null;function _(e){u&&u.unsubscribe(),u=d.channel(`messages_channel_${e.id}`),u.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver=eq.${e.id}`},async s=>{const t=s.new;n&&(t.sender===n.id&&t.receiver===a.id||t.sender===a.id&&t.receiver===n.id)&&await v(t)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`sender=eq.${e.id}`},async s=>{const t=s.new;n&&(t.sender===a.id&&t.receiver===n.id||t.sender===n.id&&t.receiver===a.id)&&await v(t)}).subscribe()}document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await d.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/login.html";return}await M()});
