import{c as y}from"./index-9sBxIpUg.js";import{s as r,p as u}from"./supabaseClient-DEpFmieI.js";async function p(){const{data:e,error:n}=await r.from("profiles").select("id,email,username");if(n){console.error("Błąd ładowania profili:",n);return}u.clear(),e.forEach(({id:t,email:i,username:o})=>{u.set(t,{email:i,username:o})})}function f(e){const n=u.get(e);return n&&(n.username||n.email)||e}let a=null,s=null;const g=document.getElementById("contactsList"),c=document.getElementById("messages"),h=document.getElementById("inputMsg"),b=document.getElementById("sendBtn");async function v(){const{data:{session:e}}=await r.auth.getSession();if(!(e!=null&&e.user)){window.location.href="login.html";return}a=e.user,await p(),C(),B(),E(a),setInterval(p,10*60*1e3)}async function C(){const{data:e,error:n}=await r.rpc("get_other_users",{current_email:a.email});if(n)return alert("Błąd ładowania kontaktów");g.innerHTML="",e.forEach(t=>{const i=document.createElement("li");i.dataset.id=t.id,i.textContent=f(t.id),i.onclick=()=>M(t),g.appendChild(i)})}async function M(e){s={id:e.id,username:f(e.id)},c.innerHTML="";const{data:n,error:t}=await r.from("messages").select("*").eq("sender",a.id).eq("receiver",e.id),{data:i,error:o}=await r.from("messages").select("*").eq("sender",e.id).eq("receiver",a.id);if(t||o)return console.error("Błąd ładowania wiadomości:",t||o),alert("Błąd ładowania wiadomości");const w=[...n,...i].sort((l,I)=>new Date(l.created_at)-new Date(I.created_at));for(const l of w)await m(l);c.scrollTop=c.scrollHeight}function B(){b.onclick=async()=>{const e=h.value.trim();if(!e||!s)return;const{error:n}=await r.from("messages").insert({sender:a.id,receiver:s.id,text:e});if(n)return alert("Błąd wysyłania");h.value=""}}async function m(e){const n=e.sender===a.id?"Ty":f(e.sender),t=document.createElement("div");t.textContent=`${n}: ${e.text}`,c.appendChild(t),c.scrollTop=c.scrollHeight}let d=null;function E(e){d&&d.unsubscribe(),d=r.channel(`messages_channel_${e.id}`),d.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver=eq.${e.id}`},async n=>{const t=n.new;s&&(t.sender===s.id&&t.receiver===a.id||t.sender===a.id&&t.receiver===s.id)&&await m(t)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`sender=eq.${e.id}`},async n=>{const t=n.new;s&&(t.sender===a.id&&t.receiver===s.id||t.sender===s.id&&t.receiver===a.id)&&await m(t)}).subscribe()}const T="https://tatiuvcmkzgcclwnehyr.supabase.co",_="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdGl1dmNta3pnY2Nsd25laHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1ODI2ODMsImV4cCI6MjA2MzE1ODY4M30.7KaomZ0tL96SldQQZc7eMPQZATYnPuiRhlVeqJsKXaE",J=y(T,_);(async()=>{const{data:{session:e}}=await J.auth.getSession();if(!(e!=null&&e.user)){window.location.href="/";return}v()})();
